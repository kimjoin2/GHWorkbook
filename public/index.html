<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GHWorkbook</title>

    <script src="https://code.jquery.com/jquery-3.5.0.min.js" integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>

<!--    &lt;!&ndash; update the version number as needed &ndash;&gt;-->
<!--    <script defer src="/__/firebase/7.14.1/firebase-app.js"></script>-->
<!--    &lt;!&ndash; include only the Firebase features as you need &ndash;&gt;-->
<!--    <script defer src="/__/firebase/7.14.1/firebase-auth.js"></script>-->
<!--    <script defer src="/__/firebase/7.14.1/firebase-database.js"></script>-->
<!--    <script defer src="/__/firebase/7.14.1/firebase-messaging.js"></script>-->
<!--    <script defer src="/__/firebase/7.14.1/firebase-storage.js"></script>-->
<!--    &lt;!&ndash; initialize the SDK after all desired features are loaded &ndash;&gt;-->
<!--    <script defer src="/__/firebase/init.js"></script>-->

    <style>
      .q-template {
        display: none;
      }
      .container {
        display: flex;
        flex-wrap: wrap;
      }
      .item {

      }
      .ans {
        font-weight: bold;
        color: red;
      }
      .hide {
        visibility: hidden;
      }
      .time {
        width: 60px;
      }
      .order, .user-order {
        width: 15px;
      }
    </style>

    <script>
      $(document).ready(function(){
        init();
      });
      function init(){
        fetch('./q.tsv')
                .then(res => res.text())
                .then(qText => {
                  const qArr = getQ(qText);
                  setView(qArr);
                });
      }

      function getQ(text, count = 5){
        const rows = text.split('\n');
        const qs = [];
        for(let i=0; i<rows.length; i++){
          const rowArr = rows[i].split('\t');
          for(let j=1; j<rowArr.length; j++){
            const q = {time:rowArr[0], content:rowArr[j], };
            qs.push(q);
          }
        }
        const res = [];
        const indexSet = {};
        for(let i=0; i<count; i++){
          const max = qs.length;
          const index = Math.round(max * Math.random() -1);
          if(indexSet[index] === undefined){
            res.push(qs[index]);
            indexSet[index] = true;
          } else {
            i--;
          }
        }
        return res;
      }
      function setView(qArray){
        const container = $('.q-container');
        container.html('');

        qArray = setOrder(qArray);

        for(let i=0; i<qArray.length; i++){
          const el = $('.q-template').clone();
          el.removeClass("q-template");
          el.find('input[type=checkbox]').removeClass('hide');

          const data = qArray[i];
          el.find('.time').text(data.time);
          el.find('.order').text(data.order);
          el.find('.content').text(data.content);
          container.append(el);
        }
      }
      function setOrder(qArray){
        qArray.sort(function(a, b){return a.time - b.time});
        for(let i=0; i<qArray.length; i++){
          qArray[i].order = i+1;
        }
        qArray.sort(() => Math.random() - Math.random());
        return qArray;
      }

      function check(){
        const arr = getQRows();
        let result = true;
        for(let i=0; i<arr.length; i++){
          const q = $(arr[i]);
          if(q.find('.user-order').text() === ""){
            alert("전부 체크 하세요.");
            return;
          }
        }
        for(let i=0; i<arr.length; i++){
          const q = $(arr[i]);
          if(q.find('.user-order').text() !== q.find('.order').text()){
            result = false;
            break;
          }
        }
        if(result){
          alert("정답");
        } else {
          alert("다음 기회에");
        }
        arr.find('.hide').removeClass('hide');
      }
      function setUserOrder(){
        const arr = getQRows();
        const checkCount = $('.q-container > .container .user-order-check:checked').length;
        let userOrderCount = 0;
        for(let i=0; i<arr.length; i++){
          if($(arr[i]).find('.user-order').text() !== ""){
            userOrderCount++;
          }
        }
        if(checkCount > userOrderCount){
          const targetArr = arr.find('input.user-order-check:checked');
          for(let i=0; i<targetArr.length; i++){
            const target = $(targetArr[i]).parent().parent().parent().find('.user-order');
            if(target.text() === ""){
              target.text(checkCount);
              break;
            }
          }
        } else {
          let deleted = -1;
          for(let i=0; i<arr.length; i++){
            const row = $(arr[i]);
            if(row.find('.user-order').text() !== "" && row.find('.user-order-check:checked').length === 0){
              deleted = parseInt(row.find('.user-order').text());
            }
          }
          for(let i=0; i<arr.length; i++){
            const target = $(arr[i]).find('.user-order');
            const targetText = target.text();
            if(targetText !== ""){
              const targetInt = parseInt(targetText);
              if(targetInt > deleted){
                target.text(targetInt-1)
              } else if(targetInt === deleted){
                target.text("");
              }
            }
          }
        }
      }
      function getQRows(){
        return $('.q-container > .container');
      }
    </script>
  </head>
  <body>
    <div>
      <h2>굿럭</h2>
      <div class="q-container"></div>
    </div>
    <div>
      <button onclick="init()">초기화</button>
      <button onclick="check()">정답 확인</button>
    </div>
    <div class="q-template container">
      <div class="item ans time hide"></div>
      <div class="item ans order hide"></div>
      <div class="item user-order"></div>
      <div class="item check">
        <label>
          <input class="user-order-check hide" type="checkbox" onclick="setUserOrder()" />
        </label>
      </div>
      <div class="item content"></div>
    </div>
  </body>
</html>
